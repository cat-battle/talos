<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Talos - Task Queue</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
    }

    header {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span { color: #8b949e; font-weight: 400; font-size: 16px; }

    .connection-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #da3633;
    }

    .connection-status.connected { background: #238636; }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    button {
      padding: 6px 12px;
      background: #238636;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    button:hover { background: #2ea043; }
    button:disabled { background: #21262d; cursor: not-allowed; opacity: 0.6; }
    button.secondary { background: #21262d; border: 1px solid #30363d; }
    button.secondary:hover { background: #30363d; }
    button.danger { background: #da3633; }
    button.danger:hover { background: #f85149; }
    button.run { background: #1f6feb; }
    button.run:hover { background: #388bfd; }
    button.stop { background: #da3633; }
    button.stop:hover { background: #f85149; }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 420px;
      height: calc(100vh - 57px);
    }

    @media (max-width: 1200px) {
      .main-layout { grid-template-columns: 1fr; }
      .output-panel { display: none; }
    }

    .board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 16px;
      overflow-y: auto;
    }

    @media (max-width: 900px) {
      .board { grid-template-columns: repeat(2, 1fr); }
    }

    .column {
      background: #161b22;
      border-radius: 8px;
      border: 1px solid #30363d;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .column-header {
      padding: 10px 12px;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .column-title {
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .column-title .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .queue .dot { background: #8957e5; }
    .running .dot { background: #d29922; animation: pulse 1.5s infinite; }
    .done .dot { background: #238636; }
    .failed .dot { background: #da3633; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .count {
      background: #30363d;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
    }

    .column-body {
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      flex: 1;
    }

    .task-card {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .task-card:hover { border-color: #58a6ff; transform: translateY(-1px); }
    .task-card.active { border-color: #d29922; background: #2d1f00; }

    .task-title {
      font-weight: 500;
      font-size: 13px;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .task-meta {
      font-size: 11px;
      color: #8b949e;
      display: flex;
      gap: 8px;
    }

    .task-actions {
      margin-top: 6px;
      display: flex;
      gap: 4px;
    }

    .task-actions button {
      padding: 3px 6px;
      font-size: 11px;
    }

    /* Output Panel */
    .output-panel {
      background: #161b22;
      border-left: 1px solid #30363d;
      display: flex;
      flex-direction: column;
    }

    .output-header {
      padding: 10px 12px;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .output-header h2 {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .output-actions {
      display: flex;
      gap: 6px;
    }

    .output-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      background: #0d1117;
    }

    .output-content .chunk { color: #c9d1d9; }
    .output-content .tool { color: #d29922; font-weight: 500; }
    .output-content .error { color: #f85149; }
    .output-content .info { color: #8b949e; font-style: italic; }
    .output-content .success { color: #3fb950; }

    /* Templates */
    .templates {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .template-btn {
      padding: 4px 8px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .template-btn:hover { border-color: #58a6ff; }

    /* Permission Modal */
    .permission-modal {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 360px;
      background: #161b22;
      border: 2px solid #d29922;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      z-index: 100;
      animation: slideIn 0.2s ease;
    }

    .permission-modal.active { display: block; }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .permission-header {
      padding: 12px;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .permission-header .icon { font-size: 20px; }

    .permission-body {
      padding: 12px;
    }

    .permission-tool {
      background: #0d1117;
      padding: 10px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .permission-footer {
      padding: 12px;
      border-top: 1px solid #30363d;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      width: 90%;
      max-width: 550px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 14px 16px;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 { font-size: 16px; font-weight: 600; }

    .modal-close {
      background: none;
      border: none;
      color: #8b949e;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
    }

    .modal-body { padding: 16px; }

    .form-group { margin-bottom: 14px; }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      color: #c9d1d9;
      font-size: 13px;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: monospace;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #58a6ff;
    }

    .modal-footer {
      padding: 14px 16px;
      border-top: 1px solid #30363d;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 30px 16px;
      color: #8b949e;
      font-size: 13px;
    }

    /* Running indicator */
    .running-indicator {
      display: none;
      align-items: center;
      gap: 6px;
      color: #d29922;
      font-size: 13px;
    }

    .running-indicator.active { display: flex; }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #30363d;
      border-top-color: #d29922;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <span class="connection-status" id="connStatus"></span>
      ü§ñ Talos
      <span>Task Queue</span>
    </h1>
    <div class="header-actions">
      <div class="running-indicator" id="runningIndicator">
        <span class="spinner"></span>
        <span>Running...</span>
        <button class="stop" onclick="stopTask()">Stop</button>
      </div>
      <button onclick="openNewTaskModal()">+ New Task</button>
    </div>
  </header>

  <div class="main-layout">
    <div class="board">
      <div class="column queue">
        <div class="column-header">
          <span class="column-title"><span class="dot"></span> Queue</span>
          <span class="count" id="queue-count">0</span>
        </div>
        <div class="column-body" id="queue-tasks"></div>
      </div>

      <div class="column running">
        <div class="column-header">
          <span class="column-title"><span class="dot"></span> Running</span>
          <span class="count" id="running-count">0</span>
        </div>
        <div class="column-body" id="running-tasks"></div>
      </div>

      <div class="column done">
        <div class="column-header">
          <span class="column-title"><span class="dot"></span> Done</span>
          <span class="count" id="done-count">0</span>
        </div>
        <div class="column-body" id="done-tasks"></div>
      </div>

      <div class="column failed">
        <div class="column-header">
          <span class="column-title"><span class="dot"></span> Failed</span>
          <span class="count" id="failed-count">0</span>
        </div>
        <div class="column-body" id="failed-tasks"></div>
      </div>
    </div>

    <div class="output-panel">
      <div class="output-header">
        <h2>üì∫ Output</h2>
        <div class="output-actions">
          <button class="secondary" onclick="clearOutput()">Clear</button>
        </div>
      </div>
      <div class="output-content" id="output"></div>
    </div>
  </div>

  <!-- Permission Request Modal -->
  <div class="permission-modal" id="permissionModal">
    <div class="permission-header">
      <span class="icon">‚ö†Ô∏è</span>
      <div>
        <strong>Permission Request</strong>
        <div style="font-size: 11px; color: #8b949e;">Copilot wants to use a tool</div>
      </div>
    </div>
    <div class="permission-body">
      <div class="permission-tool" id="permissionTool"></div>
      <div id="permissionDesc" style="font-size: 12px; color: #8b949e;"></div>
    </div>
    <div class="permission-footer">
      <button class="danger" onclick="denyPermission()">Deny</button>
      <button onclick="approvePermission()">Approve</button>
    </div>
  </div>

  <!-- New Task Modal -->
  <div class="modal-overlay" id="newTaskModal">
    <div class="modal">
      <div class="modal-header">
        <h2>New Task</h2>
        <button class="modal-close" onclick="closeModal('newTaskModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="templates" id="templates"></div>
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="taskTitle" placeholder="Brief description">
        </div>
        <div class="form-group">
          <label>Prompt</label>
          <textarea id="taskPrompt" placeholder="What should Copilot do?"></textarea>
        </div>
        <div class="form-group">
          <label>Working Directory (optional)</label>
          <input type="text" id="taskWorkDir" placeholder="/path/to/project">
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary" onclick="closeModal('newTaskModal')">Cancel</button>
        <button onclick="createTask()">Create Task</button>
      </div>
    </div>
  </div>

  <script>
    let tasks = { queue: [], running: [], done: [], failed: [] };
    let templates = [];
    let ws = null;
    let pendingPermission = null;
    let isRunning = false;

    // ============================================
    // WebSocket Connection
    // ============================================

    function connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        console.log('WebSocket connected');
        document.getElementById('connStatus').classList.add('connected');
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected');
        document.getElementById('connStatus').classList.remove('connected');
        setTimeout(connectWebSocket, 2000);
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleWSMessage(msg);
      };

      ws.onerror = (err) => console.error('WebSocket error:', err);
    }

    function handleWSMessage(msg) {
      console.log('WS:', msg.type, msg.data);

      switch (msg.type) {
        case 'task_created':
        case 'task_deleted':
        case 'task_moved':
        case 'task_completed':
        case 'task_failed':
          fetchTasks();
          if (msg.type === 'task_completed') {
            appendOutput(`\n‚úÖ Task completed\n`, 'success');
            setRunning(false);
          } else if (msg.type === 'task_failed') {
            appendOutput(`\n‚ùå Task failed: ${msg.data?.error || 'Unknown error'}\n`, 'error');
            setRunning(false);
          }
          break;

        case 'task_started':
          fetchTasks();
          appendOutput(`\n‚ñ∂ Task Started: ${msg.data.task.title}\n`, 'info');
          appendOutput(`  Prompt: ${msg.data.task.prompt}\n\n`, 'info');
          setRunning(true);
          break;

        case 'output_chunk':
          appendOutput(msg.data.text, 'chunk');
          break;

        case 'tool_use':
          appendOutput(`\nüîß [Tool: ${msg.data.tool?.name || 'unknown'}]\n`, 'tool');
          break;

        case 'tool_result':
          appendOutput(`‚úì [Tool completed]\n`, 'tool');
          break;

        case 'permission_request':
          showPermissionRequest(msg.data);
          break;

        case 'permission_resolved':
          hidePermissionRequest();
          appendOutput(`[Permission ${msg.data.decision?.outcome || 'resolved'}]\n`, 'info');
          break;

        case 'stderr':
          appendOutput(msg.data.text, 'error');
          break;

        case 'error':
          appendOutput(`Error: ${msg.data.message}\n`, 'error');
          break;

        case 'info':
          appendOutput(`‚Ñπ ${msg.data.message}\n`, 'info');
          break;
      }
    }

    function sendWS(type, data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type, data }));
      }
    }

    function setRunning(running) {
      isRunning = running;
      document.getElementById('runningIndicator').classList.toggle('active', running);
    }

    // ============================================
    // Output Panel
    // ============================================

    function appendOutput(text, className = 'chunk') {
      const output = document.getElementById('output');
      const span = document.createElement('span');
      span.className = className;
      span.textContent = text;
      output.appendChild(span);
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }

    // ============================================
    // Permission Handling
    // ============================================

    function showPermissionRequest(data) {
      pendingPermission = data;
      document.getElementById('permissionTool').textContent = data.tool || 'Unknown tool';
      document.getElementById('permissionDesc').textContent = data.description || '';
      document.getElementById('permissionModal').classList.add('active');
    }

    function hidePermissionRequest() {
      document.getElementById('permissionModal').classList.remove('active');
      pendingPermission = null;
    }

    function approvePermission() {
      sendWS('permission_response', { taskId: pendingPermission?.taskId, approved: true });
      hidePermissionRequest();
    }

    function denyPermission() {
      sendWS('permission_response', { taskId: pendingPermission?.taskId, approved: false });
      hidePermissionRequest();
    }

    // ============================================
    // Task Management
    // ============================================

    async function fetchTasks() {
      const res = await fetch('/api/tasks');
      tasks = await res.json();
      renderTasks();
    }

    async function fetchTemplates() {
      const res = await fetch('/api/templates');
      templates = await res.json();
      renderTemplates();
    }

    function renderTasks() {
      for (const status of ['queue', 'running', 'done', 'failed']) {
        const container = document.getElementById(`${status}-tasks`);
        const count = document.getElementById(`${status}-count`);
        const list = tasks[status] || [];
        
        count.textContent = list.length;
        
        if (list.length === 0) {
          container.innerHTML = '<div class="empty-state">No tasks</div>';
        } else {
          container.innerHTML = list.map(t => renderTaskCard(t, status)).join('');
        }
      }
    }

    function renderTaskCard(task, status) {
      const isActive = status === 'running';
      let actions = '';
      
      if (status === 'queue') {
        actions = `
          <button class="run" onclick="runTask('${task.id}'); event.stopPropagation();">‚ñ∂ Run</button>
          <button class="danger" onclick="deleteTask('${task.id}', '${status}'); event.stopPropagation();">‚úï</button>
        `;
      } else if (status === 'done' || status === 'failed') {
        actions = `
          <button class="secondary" onclick="requeueTask('${task.id}', '${status}'); event.stopPropagation();">‚Ü© Requeue</button>
          <button class="danger" onclick="deleteTask('${task.id}', '${status}'); event.stopPropagation();">‚úï</button>
        `;
      }

      return `
        <div class="task-card ${isActive ? 'active' : ''}" onclick="showTaskDetail('${task.id}', '${status}')">
          <div class="task-title">${escapeHtml(task.title)}</div>
          <div class="task-meta">
            <span>${task.id}</span>
            ${task.result?.durationMs ? `<span>${(task.result.durationMs/1000).toFixed(1)}s</span>` : ''}
          </div>
          ${actions ? `<div class="task-actions">${actions}</div>` : ''}
        </div>
      `;
    }

    function renderTemplates() {
      const container = document.getElementById('templates');
      container.innerHTML = templates.map(t => `
        <button class="template-btn" onclick="useTemplate('${t.id}')">
          ${t.icon || 'üìã'} ${t.title}
        </button>
      `).join('');
    }

    function useTemplate(id) {
      const template = templates.find(t => t.id === id);
      if (template) {
        document.getElementById('taskTitle').value = template.title;
        document.getElementById('taskPrompt').value = template.prompt;
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    async function runTask(taskId) {
      if (isRunning) {
        alert('A task is already running');
        return;
      }
      clearOutput();
      await fetch(`/api/tasks/${taskId}/run`, { method: 'POST' });
    }

    async function stopTask() {
      await fetch('/api/stop', { method: 'POST' });
      setRunning(false);
      appendOutput('\n‚õî Task stopped\n', 'error');
    }

    async function deleteTask(taskId, status) {
      await fetch(`/api/tasks/${taskId}?status=${status}`, { method: 'DELETE' });
    }

    async function requeueTask(taskId, status) {
      await fetch('/api/tasks/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ taskId, from: status, to: 'queue' })
      });
    }

    function showTaskDetail(taskId, status) {
      const task = tasks[status].find(t => t.id === taskId);
      if (!task) return;
      
      clearOutput();
      appendOutput(`üìã Task: ${task.title}\n`, 'info');
      appendOutput(`   ID: ${task.id}\n`, 'info');
      appendOutput(`   Created: ${new Date(task.createdAt).toLocaleString()}\n`, 'info');
      if (task.result?.durationMs) {
        appendOutput(`   Duration: ${(task.result.durationMs/1000).toFixed(1)}s\n`, 'info');
      }
      appendOutput(`\nüìù Prompt:\n${task.prompt}\n`, 'info');
      
      if (task.result?.output || task.output) {
        appendOutput(`\nüì§ Output:\n`, 'info');
        appendOutput(task.result?.output || task.output, 'chunk');
      }
      
      if (task.result?.error) {
        appendOutput(`\n‚ùå Error: ${task.result.error}\n`, 'error');
      }
    }

    // ============================================
    // Modals
    // ============================================

    function openNewTaskModal() {
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskPrompt').value = '';
      document.getElementById('taskWorkDir').value = '';
      document.getElementById('newTaskModal').classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    async function createTask() {
      const task = {
        title: document.getElementById('taskTitle').value || 'Untitled',
        prompt: document.getElementById('taskPrompt').value,
        workingDir: document.getElementById('taskWorkDir').value || null
      };

      await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(task)
      });

      closeModal('newTaskModal');
    }

    // Handle keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal('newTaskModal');
        hidePermissionRequest();
      }
      if (e.key === 'n' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        openNewTaskModal();
      }
    });

    // ============================================
    // Init
    // ============================================

    fetchTasks();
    fetchTemplates();
    connectWebSocket();
    
    // Auto-refresh tasks every 30 seconds
    setInterval(fetchTasks, 30000);
  </script>
</body>
</html>
